<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Inverter - P18 Inverter Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .navbar {
            background-color: #2c3e50;
            color: white;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            border-radius: 10px 10px 0 0 !important;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }
        .btn-success {
            background-color: #2ecc71;
            border-color: #2ecc71;
        }
        .btn-danger {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        .btn-warning {
            background-color: #f39c12;
            border-color: #f39c12;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #2ecc71;
        }
        .status-disconnected {
            background-color: #e74c3c;
        }
        .setup-section {
            margin-bottom: 30px;
        }
        .setup-section h4 {
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .info-display {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .info-item {
            margin-bottom: 10px;
        }
        .info-item strong {
            display: inline-block;
            width: 150px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">P18 Inverter Monitor</a>
            <div class="ms-auto d-flex align-items-center">
                <span id="connection-status" class="me-3">
                    <span class="status-indicator status-connected"></span>
                    Connected | EASUN IGRID SV IV
                </span>
                <a href="/setup_connection.html" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-gear-fill"></i>
                </a>
                <a href="/setup_inverter.html" class="btn btn-outline-light btn-sm active">
                    <i class="bi bi-tools"></i>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-tools"></i> Inverter Settings
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Warning: Changing these settings may affect the operation of your inverter. Make sure you understand the implications before making changes.
                        </div>

                        <!-- Current Inverter Information -->
                        <div class="info-display">
                            <h5><i class="bi bi-info-circle"></i> Current Inverter Information</h5>
                            <div class="info-item">
                                <strong>Model:</strong> <span id="model-info">Loading...</span>
                            </div>
                            <div class="info-item">
                                <strong>Serial Number:</strong> <span id="serial-info">Loading...</span>
                            </div>
                            <div class="info-item">
                                <strong>Firmware Version:</strong> <span id="firmware-info">Loading...</span>
                            </div>
                            <div class="info-item">
                                <strong>Current Time:</strong> <span id="time-info">Loading...</span>
                            </div>
                        </div>

                        <!-- Tabs for different settings -->
                        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="time-tab" data-bs-toggle="tab" data-bs-target="#time-pane" type="button" role="tab" aria-controls="time-pane" aria-selected="true">Time Settings</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="energy-tab" data-bs-toggle="tab" data-bs-target="#energy-pane" type="button" role="tab" aria-controls="energy-pane" aria-selected="false">Energy Management</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="output-tab" data-bs-toggle="tab" data-bs-target="#output-pane" type="button" role="tab" aria-controls="output-pane" aria-selected="false">Output Settings</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="battery-tab" data-bs-toggle="tab" data-bs-target="#battery-pane" type="button" role="tab" aria-controls="battery-pane" aria-selected="false">Battery Settings</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="commands-tab" data-bs-toggle="tab" data-bs-target="#commands-pane" type="button" role="tab" aria-controls="commands-pane" aria-selected="false">Commands</button>
                            </li>
                        </ul>

                        <div class="tab-content p-3" id="settingsTabsContent">
                            <!-- Time Settings Tab -->
                            <div class="tab-pane fade show active" id="time-pane" role="tabpanel" aria-labelledby="time-tab" tabindex="0">
                                <div class="setup-section">
                                    <h4>Inverter Time</h4>
                                    <div class="row align-items-center mb-4">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="current-time" class="form-label">Current Inverter Time</label>
                                                <input type="text" class="form-control" id="current-time" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-primary" id="get-time-btn">
                                                <i class="bi bi-clock"></i> Get Current Time
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="new-time" class="form-label">New Time</label>
                                                <input type="datetime-local" class="form-control" id="new-time">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-success" id="set-time-btn">
                                                <i class="bi bi-clock-history"></i> Set Time
                                            </button>
                                            <button class="btn btn-warning" id="set-current-time-btn">
                                                <i class="bi bi-clock-fill"></i> Set to Current System Time
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>AC Charge Schedule</h4>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="charge-start-time" class="form-label">Start Time</label>
                                                <input type="time" class="form-control" id="charge-start-time">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="charge-end-time" class="form-label">End Time</label>
                                                <input type="time" class="form-control" id="charge-end-time">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="charge-enabled" class="form-label">Enabled</label>
                                                <select class="form-select" id="charge-enabled">
                                                    <option value="true">Yes</option>
                                                    <option value="false">No</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <button class="btn btn-primary" id="get-charge-schedule-btn">
                                                <i class="bi bi-download"></i> Get Charge Schedule
                                            </button>
                                            <button class="btn btn-success" id="set-charge-schedule-btn">
                                                <i class="bi bi-upload"></i> Set Charge Schedule
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>AC Load Schedule</h4>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="load-start-time" class="form-label">Start Time</label>
                                                <input type="time" class="form-control" id="load-start-time">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="load-end-time" class="form-label">End Time</label>
                                                <input type="time" class="form-control" id="load-end-time">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="load-enabled" class="form-label">Enabled</label>
                                                <select class="form-select" id="load-enabled">
                                                    <option value="true">Yes</option>
                                                    <option value="false">No</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <button class="btn btn-primary" id="get-load-schedule-btn">
                                                <i class="bi bi-download"></i> Get Load Schedule
                                            </button>
                                            <button class="btn btn-success" id="set-load-schedule-btn">
                                                <i class="bi bi-upload"></i> Set Load Schedule
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Energy Management Tab -->
                            <div class="tab-pane fade" id="energy-pane" role="tabpanel" aria-labelledby="energy-tab" tabindex="0">
                                <div class="setup-section">
                                    <h4>Energy Statistics</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Total Generated Energy</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="total-energy" readonly>
                                                    <span class="input-group-text">kWh</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-primary" id="get-total-energy-btn">
                                                <i class="bi bi-lightning-charge"></i> Get Total Energy
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>Energy Data by Period</h4>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="energy-year" class="form-label">Year</label>
                                                <input type="number" class="form-control" id="energy-year" value="2024" min="2000" max="2100">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="energy-month" class="form-label">Month</label>
                                                <select class="form-select" id="energy-month">
                                                    <option value="">Select Month</option>
                                                    <option value="1">January</option>
                                                    <option value="2">February</option>
                                                    <option value="3">March</option>
                                                    <option value="4">April</option>
                                                    <option value="5">May</option>
                                                    <option value="6">June</option>
                                                    <option value="7">July</option>
                                                    <option value="8">August</option>
                                                    <option value="9">September</option>
                                                    <option value="10">October</option>
                                                    <option value="11">November</option>
                                                    <option value="12">December</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="energy-day" class="form-label">Day</label>
                                                <input type="number" class="form-control" id="energy-day" min="1" max="31">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Energy for Selected Period</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="period-energy" readonly>
                                                    <span class="input-group-text">kWh</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-primary" id="get-yearly-energy-btn">
                                                <i class="bi bi-calendar-year"></i> Get Yearly Energy
                                            </button>
                                            <button class="btn btn-primary" id="get-monthly-energy-btn">
                                                <i class="bi bi-calendar-month"></i> Get Monthly Energy
                                            </button>
                                            <button class="btn btn-primary" id="get-daily-energy-btn">
                                                <i class="bi bi-calendar-day"></i> Get Daily Energy
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>Clear Energy Data</h4>
                                    <div class="alert alert-danger">
                                        <i class="bi bi-exclamation-triangle"></i> Warning: This action will clear all energy data from the inverter and cannot be undone.
                                    </div>
                                    <button class="btn btn-danger" id="clear-energy-btn">
                                        <i class="bi bi-trash"></i> Clear All Energy Data
                                    </button>
                                </div>
                            </div>

                            <!-- Output Settings Tab -->
                            <div class="tab-pane fade" id="output-pane" role="tabpanel" aria-labelledby="output-tab" tabindex="0">
                                <div class="setup-section">
                                    <h4>Output Voltage</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="output-voltage" class="form-label">Output Voltage</label>
                                                <select class="form-select" id="output-voltage">
                                                    <option value="202.0">202.0V</option>
                                                    <option value="208.0">208.0V</option>
                                                    <option value="220.0">220.0V</option>
                                                    <option value="230.0" selected>230.0V</option>
                                                    <option value="240.0">240.0V</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-success" id="set-output-voltage-btn">
                                                <i class="bi bi-lightning"></i> Set Output Voltage
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>Output Frequency</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="output-frequency" class="form-label">Output Frequency</label>
                                                <select class="form-select" id="output-frequency">
                                                    <option value="50" selected>50Hz</option>
                                                    <option value="60">60Hz</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-success" id="set-output-frequency-btn">
                                                <i class="bi bi-activity"></i> Set Output Frequency
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Battery Settings Tab -->
                            <div class="tab-pane fade" id="battery-pane" role="tabpanel" aria-labelledby="battery-tab" tabindex="0">
                                <div class="setup-section">
                                    <h4>Battery Type</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="battery-type" class="form-label">Battery Type</label>
                                                <select class="form-select" id="battery-type">
                                                    <option value="AGM" selected>AGM</option>
                                                    <option value="Flooded">Flooded</option>
                                                    <option value="User">User</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-success" id="set-battery-type-btn">
                                                <i class="bi bi-battery"></i> Set Battery Type
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>Battery Charging Voltage</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="bulk-voltage" class="form-label">Bulk Voltage</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="bulk-voltage" value="56.4" step="0.1" min="40" max="60">
                                                    <span class="input-group-text">V</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="float-voltage" class="form-label">Float Voltage</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="float-voltage" value="54.0" step="0.1" min="40" max="60">
                                                    <span class="input-group-text">V</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <button class="btn btn-success" id="set-charging-voltage-btn">
                                                <i class="bi bi-battery-charging"></i> Set Charging Voltage
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>Battery Charging Current</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="max-charge-current" class="form-label">Max Charging Current</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="max-charge-current" value="60" step="1" min="10" max="120">
                                                    <span class="input-group-text">A</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="max-ac-charge-current" class="form-label">Max AC Charging Current</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="max-ac-charge-current" value="30" step="1" min="10" max="60">
                                                    <span class="input-group-text">A</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <button class="btn btn-success" id="set-charging-current-btn">
                                                <i class="bi bi-lightning-charge"></i> Set Charging Current
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Commands Tab -->
                            <div class="tab-pane fade" id="commands-pane" role="tabpanel" aria-labelledby="commands-tab" tabindex="0">
                                <div class="setup-section">
                                    <h4>Load Output Control</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Load Output Status</label>
                                                <input type="text" class="form-control" id="load-status" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-success" id="load-on-btn">
                                                <i class="bi bi-power"></i> Turn Load ON
                                            </button>
                                            <button class="btn btn-danger" id="load-off-btn">
                                                <i class="bi bi-power"></i> Turn Load OFF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="setup-section">
                                    <h4>Factory Reset</h4>
                                    <div class="alert alert-danger">
                                        <i class="bi bi-exclamation-triangle"></i> Warning: This will reset all settings to factory defaults and cannot be undone.
                                    </div>
                                    <button class="btn btn-danger" id="factory-reset-btn">
                                        <i class="bi bi-arrow-counterclockwise"></i> Factory Reset
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="/" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadInverterInfo();
            getCurrentTime();
            
            // Set up event listeners for time management
            document.getElementById('get-time-btn').addEventListener('click', getCurrentTime);
            document.getElementById('set-time-btn').addEventListener('click', setCustomTime);
            document.getElementById('set-current-time-btn').addEventListener('click', setCurrentSystemTime);
            document.getElementById('get-charge-schedule-btn').addEventListener('click', getChargeSchedule);
            document.getElementById('get-load-schedule-btn').addEventListener('click', getLoadSchedule);
            
            // Set up event listeners for energy management
            document.getElementById('get-total-energy-btn').addEventListener('click', getTotalEnergy);
            document.getElementById('get-yearly-energy-btn').addEventListener('click', getYearlyEnergy);
            document.getElementById('get-monthly-energy-btn').addEventListener('click', getMonthlyEnergy);
            document.getElementById('get-daily-energy-btn').addEventListener('click', getDailyEnergy);
            document.getElementById('clear-energy-btn').addEventListener('click', confirmClearEnergy);
            
            // Set up event listeners for output settings
            document.getElementById('set-output-voltage-btn').addEventListener('click', setOutputVoltage);
            document.getElementById('set-output-frequency-btn').addEventListener('click', setOutputFrequency);
            
            // Set up event listeners for commands
            document.getElementById('load-on-btn').addEventListener('click', function() { setLoadOutput(true); });
            document.getElementById('load-off-btn').addEventListener('click', function() { setLoadOutput(false); });
            document.getElementById('factory-reset-btn').addEventListener('click', confirmFactoryReset);
            
            // Initialize date inputs with current date
            const now = new Date();
            document.getElementById('energy-year').value = now.getFullYear();
            document.getElementById('energy-month').value = now.getMonth() + 1;
            document.getElementById('energy-day').value = now.getDate();
            
            // Initialize datetime-local input with current time
            const nowStr = now.toISOString().slice(0, 16);
            document.getElementById('new-time').value = nowStr;
        });
        
        // Load inverter information
        function loadInverterInfo() {
            // Get model info
            fetch('/api/v1/inverter/info/model')
                .then(response => response.json())
                .then(data => {
                    if (data.model_name) {
                        document.getElementById('model-info').textContent = data.model_name;
                    } else {
                        document.getElementById('model-info').textContent = 'Unknown';
                    }
                })
                .catch(error => {
                    console.error('Error getting model info:', error);
                    document.getElementById('model-info').textContent = 'Error';
                });
                
            // Get serial number
            fetch('/api/v1/inverter/info/serial')
                .then(response => response.json())
                .then(data => {
                    if (data.serial_number) {
                        document.getElementById('serial-info').textContent = data.serial_number;
                    } else {
                        document.getElementById('serial-info').textContent = 'Unknown';
                    }
                })
                .catch(error => {
                    console.error('Error getting serial info:', error);
                    document.getElementById('serial-info').textContent = 'Error';
                });
                
            // Get firmware version
            fetch('/api/v1/inverter/info/firmware')
                .then(response => response.json())
                .then(data => {
                    if (data.main_cpu_version) {
                        document.getElementById('firmware-info').textContent = data.main_cpu_version;
                    } else {
                        document.getElementById('firmware-info').textContent = 'Unknown';
                    }
                })
                .catch(error => {
                    console.error('Error getting firmware info:', error);
                    document.getElementById('firmware-info').textContent = 'Error';
                });
        }
        
        // Time Management Functions
        
        function getCurrentTime() {
            fetch('/api/v1/inverter/time/current')
                .then(response => response.json())
                .then(data => {
                    if (data.datetime) {
                        const dt = new Date(data.datetime);
                        document.getElementById('time-info').textContent = dt.toLocaleString();
                        document.getElementById('current-time').value = dt.toLocaleString();
                    } else {
                        document.getElementById('time-info').textContent = 'Error';
                        document.getElementById('current-time').value = 'Error';
                        console.error('Failed to get time:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error getting time:', error);
                    document.getElementById('time-info').textContent = 'Error';
                    document.getElementById('current-time').value = 'Error';
                });
        }
        
        function setCustomTime() {
            const newTimeStr = document.getElementById('new-time').value;
            if (!newTimeStr) {
                alert('Please select a time');
                return;
            }
            
            const newTime = new Date(newTimeStr);
            const isoDateTime = newTime.toISOString();
            
            fetch('/api/v1/inverter/time/current', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ datetime: isoDateTime })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Time set successfully');
                        getCurrentTime();
                    } else {
                        alert(`Failed to set time: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error setting time:', error);
                    alert('Error setting time');
                });
        }
        
        function setCurrentSystemTime() {
            const now = new Date();
            const isoDateTime = now.toISOString();
            
            fetch('/api/v1/inverter/time/current', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ datetime: isoDateTime })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Time set to current system time successfully');
                        getCurrentTime();
                    } else {
                        alert(`Failed to set time: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error setting time:', error);
                    alert('Error setting time');
                });
        }
        
        function getChargeSchedule() {
            fetch('/api/v1/inverter/time/charge-schedule')
                .then(response => response.json())
                .then(data => {
                    if (data.start_time && data.end_time) {
                        document.getElementById('charge-start-time').value = data.start_time;
                        document.getElementById('charge-end-time').value = data.end_time;
                        document.getElementById('charge-enabled').value = data.enabled.toString();
                    } else {
                        alert(`Failed to get charge schedule: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error getting charge schedule:', error);
                    alert('Error getting charge schedule');
                });
        }
        
        function getLoadSchedule() {
            fetch('/api/v1/inverter/time/load-schedule')
                .then(response => response.json())
                .then(data => {
                    if (data.start_time && data.end_time) {
                        document.getElementById('load-start-time').value = data.start_time;
                        document.getElementById('load-end-time').value = data.end_time;
                        document.getElementById('load-enabled').value = data.enabled.toString();
                    } else {
                        alert(`Failed to get load schedule: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error getting load schedule:', error);
                    alert('Error getting load schedule');
                });
        }
        
        // Energy Management Functions
        
        function getTotalEnergy() {
            fetch('/api/v1/inverter/energy/total')
                .then(response => response.json())
                .then(data => {
                    if (data.total_energy_kwh !== undefined) {
                        document.getElementById('total-energy').value = data.total_energy_kwh.toLocaleString();
                    } else {
                        document.getElementById('total-energy').value = 'Error';
                        console.error('Failed to get total energy:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error getting total energy:', error);
                    document.getElementById('total-energy').value = 'Error';
                });
        }
        
        function getYearlyEnergy() {
            const year = document.getElementById('energy-year').value;
            if (!year) {
                alert('Please enter a year');
                return;
            }
            
            fetch(`/api/v1/inverter/energy/yearly/${year}`)
                .then(response => response.json())
                .then(data => {
                    if (data.energy_kwh !== undefined) {
                        document.getElementById('period-energy').value = data.energy_kwh.toLocaleString();
                    } else {
                        document.getElementById('period-energy').value = 'Error';
                        console.error('Failed to get yearly energy:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error getting yearly energy:', error);
                    document.getElementById('period-energy').value = 'Error';
                });
        }
        
        function getMonthlyEnergy() {
            const year = document.getElementById('energy-year').value;
            const month = document.getElementById('energy-month').value;
            if (!year || !month) {
                alert('Please enter both year and month');
                return;
            }
            
            fetch(`/api/v1/inverter/energy/monthly/${year}/${month}`)
                .then(response => response.json())
                .then(data => {
                    if (data.energy_kwh !== undefined) {
                        document.getElementById('period-energy').value = data.energy_kwh.toLocaleString();
                    } else {
                        document.getElementById('period-energy').value = 'Error';
                        console.error('Failed to get monthly energy:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error getting monthly energy:', error);
                    document.getElementById('period-energy').value = 'Error';
                });
        }
        
        function getDailyEnergy() {
            const year = document.getElementById('energy-year').value;
            const month = document.getElementById('energy-month').value;
            const day = document.getElementById('energy-day').value;
            if (!year || !month || !day) {
                alert('Please enter year, month, and day');
                return;
            }
            
            // Format date as YYYY-MM-DD
            const date = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            
            fetch(`/api/v1/inverter/energy/daily/${date}`)
                .then(response => response.json())
                .then(data => {
                    if (data.energy_kwh !== undefined) {
                        document.getElementById('period-energy').value = data.energy_kwh.toLocaleString();
                    } else {
                        document.getElementById('period-energy').value = 'Error';
                        console.error('Failed to get daily energy:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error getting daily energy:', error);
                    document.getElementById('period-energy').value = 'Error';
                });
        }
        
        function confirmClearEnergy() {
            if (confirm('WARNING: This will clear all energy data from the inverter. This action cannot be undone. Continue?')) {
                clearEnergyData();
            }
        }
        
        function clearEnergyData() {
            fetch('/api/v1/inverter/energy/clear', {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Energy data cleared successfully');
                        getTotalEnergy();
                        document.getElementById('period-energy').value = '';
                    } else {
                        alert(`Failed to clear energy data: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error clearing energy data:', error);
                    alert('Error clearing energy data');
                });
        }
        
        // Output Settings Functions
        
        function setOutputVoltage() {
            const voltage = document.getElementById('output-voltage').value;
            
            fetch('/api/v1/inverter/settings/output-voltage', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ voltage: parseFloat(voltage) })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Output voltage set to ${voltage}V successfully`);
                    } else {
                        alert(`Failed to set output voltage: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error setting output voltage:', error);
                    alert('Error setting output voltage');
                });
        }
        
        function setOutputFrequency() {
            const frequency = document.getElementById('output-frequency').value;
            
            fetch('/api/v1/inverter/settings/output-frequency', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ frequency: parseInt(frequency) })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Output frequency set to ${frequency}Hz successfully`);
                    } else {
                        alert(`Failed to set output frequency: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error setting output frequency:', error);
                    alert('Error setting output frequency');
                });
        }
        
        // Command Functions
        
        function setLoadOutput(enabled) {
            fetch('/api/v1/inverter/commands/load-output', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled: enabled })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Load output ${enabled ? 'enabled' : 'disabled'} successfully`);
                        document.getElementById('load-status').value = enabled ? 'ON' : 'OFF';
                    } else {
                        alert(`Failed to set load output: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error setting load output:', error);
                    alert('Error setting load output');
                });
        }
        
        function confirmFactoryReset() {
            if (confirm('WARNING: This will reset all settings to factory defaults. This action cannot be undone. Continue?')) {
                factoryReset();
            }
        }
        
        function factoryReset() {
            fetch('/api/v1/inverter/commands/factory-reset', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Factory reset successful');
                    } else {
                        alert(`Failed to perform factory reset: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error performing factory reset:', error);
                    alert('Error performing factory reset');
                });
        }
    </script>
</body>
</html>