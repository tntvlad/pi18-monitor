<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P18 Inverter Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        .header-title {
            font-size: 2rem;
            font-weight: 500;
            margin: 0;
        }
        .status-badge {
            background-color: rgba(52, 73, 94, 0.7);
            border-radius: 50px;
            padding: 8px 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .status-connected {
            background-color: #2ecc71;
        }
        .status-disconnected {
            background-color: #e74c3c;
        }
        .setup-link {
            color: #3498db;
            text-decoration: none;
            margin-left: 10px;
            font-weight: 500;
        }
        .setup-link:hover {
            text-decoration: underline;
            color: #2980b9;
        }
        .info-card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            border: none;
        }
        .info-card-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
            font-weight: 600;
            background-color: white;
        }
        .info-card-body {
            padding: 0;
        }
        .info-item {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
            background-color: #f8f9fa;
            margin-bottom: 1px;
        }
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .info-label {
            color: #7f8c8d;
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .info-value {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .action-button {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .action-button i {
            font-size: 1.2rem;
            margin-right: 8px;
        }
        .action-button.refresh {
            color: #3498db;
        }
        .action-button.time {
            color: #2ecc71;
        }
        .action-button.clear {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="header-title">P18 Inverter Monitor</h1>
                <div class="d-flex align-items-center">
                    <div class="status-badge">
                        <span class="status-indicator status-connected"></span>
                        Connected | EASUN IGRID SV IV
                    </div>
                    <a href="/setup_inverter.html" class="setup-link">Setup</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-button refresh" id="refresh-data-btn">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
            <button class="action-button time" id="set-time-btn">
                <i class="bi bi-clock"></i> Set Current Time
            </button>
            <button class="action-button clear" id="clear-energy-btn">
                <i class="bi bi-trash"></i> Clear Energy Data
            </button>
        </div>

        <div class="row">
            <!-- System Information Card -->
            <div class="col-md-4">
                <div class="info-card">
                    <div class="info-card-header">System Information</div>
                    <div class="info-card-body">
                        <div class="info-item">
                            <div class="info-label">Machine Model</div>
                            <div class="info-value" id="machine-model">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Model Code</div>
                            <div class="info-value" id="model-code">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Serial Number</div>
                            <div class="info-value" id="serial-number">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Main CPU Version</div>
                            <div class="info-value" id="main-cpu-version">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inverter Status Card -->
            <div class="col-md-4">
                <div class="info-card">
                    <div class="info-card-header">Inverter Status</div>
                    <div class="info-card-body">
                        <div class="info-item">
                            <div class="info-label">Grid Voltage</div>
                            <div class="info-value" id="grid-voltage">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Grid Frequency</div>
                            <div class="info-value" id="grid-frequency">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Output Voltage</div>
                            <div class="info-value" id="output-voltage">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Output Frequency</div>
                            <div class="info-value" id="output-frequency">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Power Generation Card -->
            <div class="col-md-4">
                <div class="info-card">
                    <div class="info-card-header">Power Generation</div>
                    <div class="info-card-body">
                        <div class="info-item">
                            <div class="info-label">PV1 Power</div>
                            <div class="info-value" id="pv1-power">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">PV2 Power</div>
                            <div class="info-value" id="pv2-power">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">PV1 Voltage</div>
                            <div class="info-value" id="pv1-voltage">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">PV2 Voltage</div>
                            <div class="info-value" id="pv2-voltage">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Battery Status Card -->
            <div class="col-md-6">
                <div class="info-card">
                    <div class="info-card-header">Battery Status</div>
                    <div class="info-card-body">
                        <div class="info-item">
                            <div class="info-label">Battery Voltage</div>
                            <div class="info-value" id="battery-voltage">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Battery Capacity</div>
                            <div class="info-value" id="battery-capacity">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Charging Current</div>
                            <div class="info-value" id="charging-current">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Discharging Current</div>
                            <div class="info-value" id="discharging-current">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Energy Statistics Card -->
            <div class="col-md-6">
                <div class="info-card">
                    <div class="info-card-header">Energy Statistics</div>
                    <div class="info-card-body">
                        <div class="info-item">
                            <div class="info-label">Total Energy</div>
                            <div class="info-value" id="total-energy">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Today's Energy</div>
                            <div class="info-value" id="daily-energy">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Monthly Energy</div>
                            <div class="info-value" id="monthly-energy">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Yearly Energy</div>
                            <div class="info-value" id="yearly-energy">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Action button event listeners
            document.getElementById('refresh-data-btn').addEventListener('click', function() {
                loadAllData();
            });
            
            document.getElementById('set-time-btn').addEventListener('click', function() {
                setCurrentTime();
            });
            
            document.getElementById('clear-energy-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all energy data? This action cannot be undone.')) {
                    clearEnergyData();
                }
            });
            
            // Load initial data
            loadAllData();
            
            // Set up auto-refresh every 30 seconds
            setInterval(loadAllData, 30000);
        });
        
        function loadAllData() {
            // Load system information
            loadSystemInfo();
            
            // Load inverter status
            loadInverterStatus();
            
            // Load power generation
            loadPowerGeneration();
            
            // Load battery status
            loadBatteryStatus();
            
            // Load energy statistics
            loadEnergyStatistics();
        }
        
        function loadSystemInfo() {
            // Get model info
            fetch('/api/v1/inverter/info/model')
                .then(response => response.json())
                .then(data => {
                    if (data.model_name) {
                        document.getElementById('machine-model').textContent = data.model_name;
                        document.getElementById('model-code').textContent = data.model_code || 'N/A';
                    } else {
                        document.getElementById('machine-model').textContent = 'Error';
                        document.getElementById('model-code').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading model info:', error);
                    document.getElementById('machine-model').textContent = 'Error';
                    document.getElementById('model-code').textContent = 'Error';
                });
            
            // Get serial number
            fetch('/api/v1/inverter/info/serial')
                .then(response => response.json())
                .then(data => {
                    if (data.serial_number) {
                        document.getElementById('serial-number').textContent = data.serial_number;
                    } else {
                        document.getElementById('serial-number').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading serial number:', error);
                    document.getElementById('serial-number').textContent = 'Error';
                });
            
            // Get firmware version
            fetch('/api/v1/inverter/info/firmware')
                .then(response => response.json())
                .then(data => {
                    if (data.main_cpu_version) {
                        document.getElementById('main-cpu-version').textContent = data.main_cpu_version;
                    } else {
                        document.getElementById('main-cpu-version').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading firmware version:', error);
                    document.getElementById('main-cpu-version').textContent = 'Error';
                });
        }
        
        function loadInverterStatus() {
            fetch('/api/v1/inverter/data/status')
                .then(response => response.json())
                .then(data => {
                    if (data.grid) {
                        document.getElementById('grid-voltage').textContent = data.grid.voltage + ' V';
                        document.getElementById('grid-frequency').textContent = data.grid.frequency + ' Hz';
                    } else {
                        document.getElementById('grid-voltage').textContent = 'Error';
                        document.getElementById('grid-frequency').textContent = 'Error';
                    }
                    
                    if (data.output) {
                        document.getElementById('output-voltage').textContent = data.output.voltage + ' V';
                        document.getElementById('output-frequency').textContent = data.output.frequency + ' Hz';
                    } else {
                        document.getElementById('output-voltage').textContent = 'Error';
                        document.getElementById('output-frequency').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading inverter status:', error);
                    document.getElementById('grid-voltage').textContent = 'Error';
                    document.getElementById('grid-frequency').textContent = 'Error';
                    document.getElementById('output-voltage').textContent = 'Error';
                    document.getElementById('output-frequency').textContent = 'Error';
                });
        }
        
        function loadPowerGeneration() {
            fetch('/api/v1/inverter/data/status')
                .then(response => response.json())
                .then(data => {
                    if (data.pv) {
                        document.getElementById('pv1-power').textContent = data.pv.pv1_power + ' W';
                        document.getElementById('pv2-power').textContent = data.pv.pv2_power + ' W';
                        document.getElementById('pv1-voltage').textContent = data.pv.pv1_voltage + ' V';
                        document.getElementById('pv2-voltage').textContent = data.pv.pv2_voltage + ' V';
                    } else {
                        document.getElementById('pv1-power').textContent = 'Error';
                        document.getElementById('pv2-power').textContent = 'Error';
                        document.getElementById('pv1-voltage').textContent = 'Error';
                        document.getElementById('pv2-voltage').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading power generation:', error);
                    document.getElementById('pv1-power').textContent = 'Error';
                    document.getElementById('pv2-power').textContent = 'Error';
                    document.getElementById('pv1-voltage').textContent = 'Error';
                    document.getElementById('pv2-voltage').textContent = 'Error';
                });
        }
        
        function loadBatteryStatus() {
            fetch('/api/v1/inverter/data/status')
                .then(response => response.json())
                .then(data => {
                    if (data.battery) {
                        document.getElementById('battery-voltage').textContent = data.battery.voltage + ' V';
                        document.getElementById('battery-capacity').textContent = data.battery.capacity_percent + '%';
                        document.getElementById('charging-current').textContent = data.battery.charging_current + ' A';
                        document.getElementById('discharging-current').textContent = data.battery.discharge_current + ' A';
                    } else {
                        document.getElementById('battery-voltage').textContent = 'Error';
                        document.getElementById('battery-capacity').textContent = 'Error';
                        document.getElementById('charging-current').textContent = 'Error';
                        document.getElementById('discharging-current').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading battery status:', error);
                    document.getElementById('battery-voltage').textContent = 'Error';
                    document.getElementById('battery-capacity').textContent = 'Error';
                    document.getElementById('charging-current').textContent = 'Error';
                    document.getElementById('discharging-current').textContent = 'Error';
                });
        }
        
        function loadEnergyStatistics() {
            // Get total energy
            fetch('/api/v1/inverter/energy/total')
                .then(response => response.json())
                .then(data => {
                    if (data.total_energy_kwh !== undefined) {
                        document.getElementById('total-energy').textContent = data.total_energy_kwh.toLocaleString() + ' kWh';
                    } else {
                        document.getElementById('total-energy').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading total energy:', error);
                    document.getElementById('total-energy').textContent = 'Error';
                });
            
            // Get today's energy
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10); // YYYY-MM-DD
            
            fetch(`/api/v1/inverter/energy/daily/${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.energy_kwh !== undefined) {
                        document.getElementById('daily-energy').textContent = data.energy_kwh.toLocaleString() + ' kWh';
                    } else {
                        document.getElementById('daily-energy').textContent = '0 kWh';
                    }
                })
                .catch(error => {
                    console.error('Error loading daily energy:', error);
                    document.getElementById('daily-energy').textContent = 'Error';
                });
            
            // Get monthly energy
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            
            fetch(`/api/v1/inverter/energy/monthly/${year}/${month}`)
                .then(response => response.json())
                .then(data => {
                    if (data.energy_kwh !== undefined) {
                        document.getElementById('monthly-energy').textContent = data.energy_kwh.toLocaleString() + ' kWh';
                    } else {
                        document.getElementById('monthly-energy').textContent = '0 kWh';
                    }
                })
                .catch(error => {
                    console.error('Error loading monthly energy:', error);
                    document.getElementById('monthly-energy').textContent = 'Error';
                });
            
            // Get yearly energy
            fetch(`/api/v1/inverter/energy/yearly/${year}`)
                .then(response => response.json())
                .then(data => {
                    if (data.energy_kwh !== undefined) {
                        document.getElementById('yearly-energy').textContent = data.energy_kwh.toLocaleString() + ' kWh';
                    } else {
                        document.getElementById('yearly-energy').textContent = '0 kWh';
                    }
                })
                .catch(error => {
                    console.error('Error loading yearly energy:', error);
                    document.getElementById('yearly-energy').textContent = 'Error';
                });
        }
        
        function setCurrentTime() {
            const now = new Date();
            const isoDateTime = now.toISOString();
            
            fetch('/api/v1/inverter/time/current', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ datetime: isoDateTime })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Inverter time set successfully to current system time.');
                    } else {
                        alert(`Failed to set inverter time: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error setting time:', error);
                    alert('Error setting inverter time');
                });
        }
        
        function clearEnergyData() {
            fetch('/api/v1/inverter/energy/clear', {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Energy data cleared successfully');
                        loadEnergyStatistics(); // Reload energy statistics
                    } else {
                        alert(`Failed to clear energy data: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error clearing energy data:', error);
                    alert('Error clearing energy data');
                });
        }
    </script>
</body>
</html>